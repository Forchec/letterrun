<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Letter Run - Test Stage</title>
    <script type="text/javascript" src="js/lib/jquery-1.11.1.min.js" ></script>
    <!-- <script>
      $(function(){ $("head").load("/../Fixed/header.html") });
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>

    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

//alert("Test Stage is called")

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var enemys;
var door;
var letters;
var platforms;
var cursors;
var gameOver = false;

var WORD = "penguin"; // change word for each stage
var alpha = "abcdefghijklmnopqrstuvwxyz"; // don't change
var WORD_LEN = WORD.length;
var letterCount = WORD_LEN + 8; // the int is the count of random letters
var letterBoard = []; // array of letters that the player collected

var letter = ''; // only used once??

var tmp;
var i = 0;
var x_for_board; // x-axis for board display
var x = Math.floor(Math.random() * (770 - 30 + 1) + 30); // x pos for collectable letter
var y = Math.floor(Math.random() * 400); // y pos for collectable letter

var xList = []; // array of x-axis
var yList = []; // array of y-axis

var visitChecker = [] // check if a letter in the word is collected
for (var i = 0; i < WORD_LEN; i++){
  visitChecker.push("");
}

var xChecker = [];
for (var i = 0; i < letterCount; i++){
  xChecker.push(0);
}

var game = new Phaser.Game(config);

function preload ()
{
    var current = '';
    for (var i = 0; i < 26; i++) {
      current = alpha.charAt(i);    // Collectable letters
      this.load.image(current, '../assets/' + current + '.png');
      current = alpha.charAt(i) + alpha.charAt(i);  // Color-box letters
      this.load.image(current, '../assets/' + current + '.png');
      current = alpha.charAt(i) + alpha.charAt(i) + alpha.charAt(i); // Gray-box letters
      this.load.image(current, '../assets/' + current + '.png');
    }
    this.load.image('door', '../assets/door.png');
    this.load.image('sky', '../assets/sky.png');
    this.load.image('ground', '../assets/platform.png');
    this.load.image('wall', '../assets/invisibleWall.png');
    this.load.image('worldWall', '../assets/worldWall.png');
    //this.load.spritesheet('enemy', '../assets/enemy.png',{frameWidth: 64, frameHeight: 64});
    this.load.spritesheet('dude', '../newAssets/character/Run/1x.png', { frameWidth: 2, frameHeight: 4 });
    this.load.spritesheet('testEnemy', '../assets/dude.png', { frameWidth: 32, frameHeight: 48 });

}

function create ()
{
    //  A simple background for our game
    this.add.image(400, 300, 'sky');

    // Display initial board (grayed-out version)
    for(i = 0; i < WORD_LEN; i++){
      x_for_board = 25 + (50 * i);
      letter = WORD.charAt(i) + WORD.charAt(i) + WORD.charAt(i);
      tmp = this.add.sprite(x_for_board, 25, letter);
      tmp.setDisplaySize(40, 40);
    }

    // Display the door in a specific location - Change each stage
    door = this.physics.add.sprite(700, 140, 'door');

    door.setDisplaySize(80, 126);


    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = this.physics.add.staticGroup();
    walls =this.physics.add.staticGroup();

    this.physics.add.collider(door, platforms);

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    platforms.create(400, 568, 'ground').setScale(2).refreshBody();


    //  Now let's create some ledges
    platforms.create(600, 400, 'ground');
    platforms.create(50, 250, 'ground');
    platforms.create(750, 220, 'ground');


    enemies = this.physics.add.group();


    var first = 0;
    walls.create(1,500,'worldWall');
    walls.create(797,500,'worldWall');
    walls.create(1,100,'worldWall');
    walls.create(797,100,'worldWall');

    platforms.children.iterate(function (child) {
        if (first != 0){

            walls.create(child.x-200,child.y-20,'wall');
            walls.create(child.x+200,child.y-20,'wall');
            enemies.create(child.x, child.y-40,'testEnemy');
        }
        // allLetters.create(child.x-70, child.y-60,'a');
        //if (child.x-70>0)
        // allLetters.create(child.x+70, child.y-60,'b');
        // allLetters.create(child.x-140, child.y-60,'c');
        // allLetters.create(child.x+140, child.y-60,'d');

          first ++;
    });

    enemies.create(780, 510,'testEnemy');

    first = 0;

    walls.children.iterate(function (child) {
        //  make enemy move
        child.alpha = 0;
        child.body.immovable = true;
    });

    // The player and its settings
    player = this.physics.add.sprite(100, 450, 'dude');

    //enemys
    this.anims.create({
      key: 'enemyMove',
      frames: this.anims.generateFrameNumbers('testEnemy',{start:0, end:3}),
      frameRate: 10,
      repeat: -1
    })

    this.anims.create({
      key: 'enemyTurn',
      frames: this.anims.generateFrameNumbers('testEnemy',{start:5, end:8}),
      frameRate: 10,
      repeat: -1
    })
// //
//     enemies = this.physics.add.group({
//       key:'testEnemy',
//       repeat: 1,
//       setXY: {x:750, y:170, stepX: -150, stepY: 150}
//     })
//
    enemies.children.iterate(function (child) {
        //  make enemy move
        child.anims.play('enemyMove',true);
        //Set speed randomly
        child.setTint(0x5e92e5);
        child.setVelocityX(Math.floor(Math.random()*( -20 + 1)) + -50);
        child.body.allowGravity =false;
      //  child.body
        //console.log(child.body)
        child.body.setSize(13,13,2,2);
        child.body.immovable = true;
    });



    //  Player physics properties. Give the little guy a slight bounce.
    player.setBounce(0.2);
    player.setCollideWorldBounds(true);
    //player.body.immovable =true;

    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude'.flipX, { start: 0, end: 11 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude'.flipX, frame: 10 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();

  // Get a list of random x values so that there is no overlap
  for (i = 0; i < letterCount; i++){
    while (checkOverlap() === 1){
        x = Math.floor(Math.random() * (770 - 30 + 1) + 30); // set the range from 30 to 770

//////imimimimportante finish by this week///////////////// - random letter random pos
  for (i = 0; i < WORD_LEN + 10; i++){
    // array for x and y
  }
  var x = Math.floor(Math.random() * 700) + Math.floor(Math.random() * 50);
  var y = Math.floor(Math.random() * 400);
  console.log(x);
  console.log(y);
  // Display neccessary letters (letters to make the word)
  for (i = 0; i < WORD_LEN; i++){
    tmp = WORD.charAt(i);
    letters = this.physics.add.sprite(x, y, tmp);

  // Get a list of x values so that there is no overlap
  for (i = 0; i < WORD_LEN + 8; i++){
     while (checkOverlap() === 1){
        x = Math.floor(Math.random() * 800);
      }
    xList.push(x);
    yList.push(y);
    x = Math.floor(Math.random() * (770 - 30 + 1) + 30);
    y = Math.floor(Math.random() * 400);
  }

  // Place collectable letters
  for (i = 0; i < letterCount; i++){
    if (i < WORD_LEN){
      tmp = WORD.charAt(i); // must display the letters in the word
    }
    else {
      tmp = chooseRandomLetter(alpha);
    }
    letter = this.physics.add.sprite(xList[i], yList[i], tmp);

    if (tmp == 'w'){ // make w size equal to others
      letter.setDisplaySize(50, 50);
    }
    else{
      letter.setDisplaySize(40, 40);
    }

    this.physics.add.collider(letter, platforms);
    this.physics.add.overlap(player, letter, collectLetter, null, this);
    letter.myName = tmp;
  }

    //  Collide the player with the platforms
    this.physics.add.collider(player, platforms);

    //  Collide the enemy with the platforms
    this.physics.add.collider(enemies, platforms);

    //  Checks to see if the player overlaps with any of the letters, if he does call the collectLetter function
    //this.physics.add.overlap(player, letter, collectLetter, null, this);

    //  Checks to see if the player overlaps with any of the enemies, if he does call the hitEnemy function
    this.physics.add.overlap(player, enemies, hitEnemy, null, this);

    //this.physics.add.collider(player, enemies, enemyCollision, null, this);

    this.physics.add.overlap(enemies, walls, hitWall, null, this);

    //  Checks to see if the player overlaps with door, if he does call the hitDoor function
    this.physics.add.overlap(player, door, hitDoor, null, this);
}

function update ()
{
    if (gameOver)
    {
        return;
    }

    if (cursors.left.isDown)
    {
        player.setVelocityX(-160);

        player.anims.play('left', true);
    }
    else if (cursors.right.isDown)
    {
        player.setVelocityX(160);

        player.anims.play('right', true);
    }
    else
    {
        player.setVelocityX(0);

        player.anims.play('turn');
    }

    if (cursors.up.isDown && player.body.touching.down)
    {
        player.setVelocityY(-330);
    }
}

// Chooses a random letter from the given string
function chooseRandomLetter(str){
  var index = Math.floor(Math.random() * str.length);
  var ret = '';
  ret += str.charAt(index);
  return ret;
}

// Updates letter board as the player collects the letter
function collectLetter(player, letter)
{
  letter.disableBody(true, true);
  var cur = '';
  for (i = 0; i < WORD_LEN; i++){
    if (letter.myName === WORD.charAt(i)){
      if (visitChecker[i] != "visited"){
        // Updates letter board
        x_for_board = 25;
        cur = WORD.charAt(i) + WORD.charAt(i);
        x_for_board = x_for_board + (50 * i);
        tmp = this.add.sprite(x_for_board, 25, cur);
        tmp.setDisplaySize(40, 40);
        visitChecker[i] = "visited";
        var index = xList.indexOf(letter.x);
        xChecker[index] = 0;
        letterBoard.push(letter.myName);
        break;
      }
      else{
        continue;
      }
    }
  }
}

// Checks if there is a overlapping x value in xList
function checkOverlap(){
  var len = xList.length;
  for (i = 0; i < len; i++){
    if (x < xList[i] + 40 && x > xList[i] - 40){
      return 1;
    }
  }
  return 0;
}

// Checks the letter board to either kill or take away a letter
function hitEnemy (player, enemy){
  // Kills the player when no letter is collected
  if (letterBoard === undefined || letterBoard.length == 0){
    this.physics.pause();
    player.setTint(0xff0000);
    player.anims.play('turn');
    gameOver = true;
  }
  else{ // Takes away one random letter from the letter board
    player.immune = true;
    enemy.follow = false;
    // Enemy will hit and change its moving direction
    if (enemy.body.touching.left){
      enemy.body.velocity.x = 256;
      enemy.anims.play('enemyTurn', true);
    }
    else if (enemy.body.touching.right){

      enemy.body.velocity.x = -256;
      enemy.anims.play('enemyMove', true);
    }
    else if (enemy.body.touching.up){
      // Dont know what to do when the player jumps on the enemy
      //enemy.disableBody(true, true); // probably killing enemy??
    }

    var len = letterBoard.length;
    var index = Math.floor(Math.random() * len);
    var char = letterBoard[index];
    for (i = 0; i < WORD_LEN; i++){
      if (char === WORD.charAt(i)){
        if (visitChecker[i] === "visited"){
          // Update the letter board
          var x_ = 25;
          var cur = char + char + char;
          x_ = x_ + (50 * i);
          tmp = this.add.sprite(x_, 25, cur);
          tmp.setDisplaySize(40, 40);
          letterBoard.splice(index, 1);
          visitChecker[i] = "";

          // Place the letter that's taken away to be colleted again
          // (NOT random -- same position as before -- NEEDS A FIX)
          letters = this.physics.add.sprite(xList[i], yList[i], char);
          if (char == 'w'){
            letters.setDisplaySize(50, 50);
          }
          else{
            letters.setDisplaySize(40, 40);
          }
          this.physics.add.collider(letters, platforms);

          this.physics.add.overlap(player, letters, collectLetter, null, this);

          letters.myName = char;
          break;
        }
        else{
          continue;
        }

        console.log(letterBoard);
      }

    }

    }
  }

// Checks if all letters have been collected to make the game over or not
function hitDoor (player, door)
{
  var cond = true;
  for (var i = 0; i < WORD_LEN; i++){
    if (visitChecker[i] != "visited"){
      cond = false;
    }
  }
  if (cond === true){
    this.physics.pause();
    player.anims.play('turn');
    gameOver = true;
  }
}

function enemyCollision(player, enemy){
  //this.physics.pause();

}

function hitWall(enemy, wall){
    console.log("hitWall");
    var speed = enemy.body.velocity.x
    speed = -1 *speed;
    enemy.body.setVelocityX(speed);
    //enemy is moving leftwards
    if ( speed >0){
        enemy.anims.play("enemyTurn",true)
    }
    else{
        enemy.anims.play("enemyMove",true)
    }

    //console.log(enemy.body.velocity.x)
}

</script>

</body>
</html>
