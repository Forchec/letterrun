<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Letter Run - Test Stage</title>
    <script type="text/javascript" src="js/lib/jquery-1.11.1.min.js" ></script>
    <!-- <script>
      $(function(){ $("head").load("/../Fixed/header.html") });
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>

    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

//alert("Test Stage is called")

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
// var stars;
var letters;
var enemys;
var platforms;
var cursors;
var gameOver = false;


var WORD = "penguin"; // check with repeated letter
var WORD_LEN = WORD.length;

var letterBoard = [];
var alpha = "abcdefghijklmnopqrstuvwxyz";
var x_for_board;
var tmp;
var retmp;
var letter = '';
var i = 0;
var door;
var visitChecker = []
var allLetters;
for (var i = 0; i < WORD_LEN; i++){
  visitChecker.push("");
}
var x = Math.floor(Math.random() * 800);
var y = Math.floor(Math.random() * 400);
var xList = [];
var yList = [];


var game = new Phaser.Game(config);

function preload ()
{
    var current = '';
    for (var i = 0; i < 26; i++) {
      current = alpha.charAt(i);    // Collectable letters
      this.load.image(current, '../assets/' + current + '.png');
      current = alpha.charAt(i) + alpha.charAt(i);  // Color-box letters
      this.load.image(current, '../assets/' + current + '.png');
      current = alpha.charAt(i) + alpha.charAt(i) + alpha.charAt(i); // Gray-box letters
      this.load.image(current, '../assets/' + current + '.png');
    }
    this.load.image('door', '../assets/door.png');
    this.load.image('sky', '../assets/sky.png');
    this.load.image('ground', '../assets/platform.png');
    this.load.image('wall', '../assets/invisibleWall.png');
    this.load.image('worldWall', '../assets/worldWall.png');
    //this.load.spritesheet('enemy', '../assets/enemy.png',{frameWidth: 64, frameHeight: 64});
    this.load.spritesheet('dude', '../assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    this.load.spritesheet('testEnemy', '../assets/dude.png', { frameWidth: 32, frameHeight: 48 });

}

function create ()
{
    //  A simple background for our game
    this.add.image(400, 300, 'sky');

    // Display initial board (grayed-out version)
    for(i = 0; i < WORD_LEN; i++){
      x_for_board = 25 + (50 * i);
      letter = WORD.charAt(i) + WORD.charAt(i) + WORD.charAt(i);
      tmp = this.add.sprite(x_for_board, 25, letter);
      tmp.setDisplaySize(40, 40);
    }

    door = this.physics.add.sprite(700, 140, 'door');

    door.setDisplaySize(80, 126); // 70 110


    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = this.physics.add.staticGroup();
    walls =this.physics.add.staticGroup();
this.physics.add.collider(door, platforms);
    //  Here we create the ground.
    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    platforms.create(400, 568, 'ground').setScale(2).refreshBody();


    //  Now let's create some ledges
    platforms.create(600, 400, 'ground');
    platforms.create(50, 250, 'ground');
    platforms.create(750, 220, 'ground');


    enemies = this.physics.add.group();


    var first = 0;
    walls.create(1,500,'worldWall');
    walls.create(797,500,'worldWall');
    walls.create(1,100,'worldWall');
    walls.create(797,100,'worldWall');


    // var letterArray = [70,140,210,280,350]
    // allLetters = this.physics.add.group();
    platforms.children.iterate(function (child) {

        if (first != 0){



            walls.create(child.x-200,child.y-20,'wall');
            walls.create(child.x+200,child.y-20,'wall');
            enemies.create(child.x, child.y-40,'testEnemy');
        }


          first ++;
    });
    enemies.create(780, 510,'testEnemy');
    first = 0;

    // allLetters.children.iterate(function (child) {
    //     //  make enemy move
    //     child.setDisplaySize(50,50);
    // });

    walls.children.iterate(function (child) {
        //  make enemy move
        child.alpha = 0;
        child.body.immovable = true;
    });

    // The player and its settings
    player = this.physics.add.sprite(100, 450, 'dude');

    //enemys
    this.anims.create({
      key: 'enemyMove',
      frames: this.anims.generateFrameNumbers('testEnemy',{start:0, end:3}),
      frameRate: 10,
      repeat: -1
    })

    this.anims.create({
      key: 'enemyTurn',
      frames: this.anims.generateFrameNumbers('testEnemy',{start:5, end:8}),
      frameRate: 10,
      repeat: -1
    })

    // enemies = this.physics.add.group({
    //   key:'testEnemy',
    //   repeat: 1,
    //   setXY: {x:750, y:170, stepX: -150, stepY: 150}
    // })

    enemies.children.iterate(function (child) {
        //  make enemy move
        child.anims.play('enemyMove',true);
        //Set speed randomly
        child.setTint(0x5e92e5);
        child.setVelocityX(Math.floor(Math.random()*( -20 + 1)) + -50);
        child.body.allowGravity =false;
        //console.log(child.body)
        child.body.setSize(13,13,2,2);
      //  child.body.immovable = true;
    });



    //  Player physics properties. Give the little guy a slight bounce.
    player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });



    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();


  // Get a list of x values so that there is no overlap
  for (i = 0; i < WORD_LEN + 8; i++){
     while (checkOverlap() === 1){
        x = Math.floor(Math.random() * 800);
      }
    xList.push(x);
    yList.push(y);
    x = Math.floor(Math.random() * 800);
    y = Math.floor(Math.random() * 400);
  }

  // Display collectable letters
  for (i = 0; i < WORD_LEN + 8; i++){
    if (i < WORD_LEN){
      tmp = WORD.charAt(i);
    }
    else {
      tmp = chooseRandomLetter(alpha);
    }
    letters = this.physics.add.sprite(xList[i], yList[i], tmp);
    if (tmp == 'w'){
      letters.setDisplaySize(50, 50);
    }
    else{
      letters.setDisplaySize(40, 40);
    }
    this.physics.add.collider(letters, platforms);

    this.physics.add.overlap(player, letters, collectLetter, null, this);
    //this.physics.add.overlap(player, enemy, letterAway, null, this);
    letters.myName = tmp;

  }



    //  Collide the player with the platforms
    this.physics.add.collider(player, platforms);

    this.physics.add.collider(enemies, platforms);
    this.physics.add.collider(allLetters, platforms);



    //  Checks to see if the player overlaps with any of the letters, if he does call the collectLetter function
    this.physics.add.overlap(player, letters, collectLetter, null, this);

    //this.physics.add.collider(player, enemy, hitEnemy, null, this);
    this.physics.add.collider(player, enemies, hitEnemy, null, this);

    this.physics.add.collider(player, enemies, enemyCollision, null, this);

    // enemy.setVelocityX(160);
    // enemy.anims.play('enemyMove', true);
    this.physics.add.overlap(enemies, walls, hitWall, null, this);

    this.physics.add.overlap(player, door, hitDoor, null, this);
}

function update ()
{
    if (gameOver)
    {
        return;
    }

    if (cursors.left.isDown)
    {
        player.setVelocityX(-160);

        player.anims.play('left', true);
    }
    else if (cursors.right.isDown)
    {
        player.setVelocityX(160);

        player.anims.play('right', true);
    }
    else
    {
        player.setVelocityX(0);

        player.anims.play('turn');
    }

    if (cursors.up.isDown && player.body.touching.down)
    {
        player.setVelocityY(-330);
    }
}

function chooseRandomLetter(str){
  var index = Math.floor(Math.random() * str.length);
  var ret = '';
  ret += str.charAt(index);
  return ret;
}

function collectLetter(player, letter)
{

  letter.disableBody(true, true);

  var cur = '';
  for (i = 0; i < WORD_LEN; i++){
    if (letter.myName === WORD.charAt(i)){
      if (visitChecker[i] != "visited"){
        x_for_board = 25;
        cur = WORD.charAt(i) + WORD.charAt(i);
        x_for_board = x_for_board + (50 * i);
        tmp = this.add.sprite(x_for_board, 25, cur);
        tmp.setDisplaySize(40, 40);
        visitChecker[i] = "visited";
        letterBoard.push(letter.myName);
        break;
      }
      else{
        continue;
      }
    }
  }
}

function checkOverlap(){
  var len = xList.length;
  for (i = 0; i < len; i++){
    if (x < xList[i] + 40 && x > xList[i] - 40){
      return 1;
    }
  }
  return 0;
}

function hitEnemy (player, enemy){
  console.log(letterBoard);
  if (letterBoard === undefined || letterBoard.length == 0){
    this.physics.pause();

    player.setTint(0xff0000);

    player.anims.play('turn');

    gameOver = true;
  }
  else{ // Take away a random letter
    // taking away a letter is working, but one collision makes
    // the character to loose all letter and lose game..
    // PLUS, it should also display the collectable letters :)
    var len = letterBoard.length;
    var index = Math.floor(Math.random() * len);
    var char = letterBoard[index];
    for (i = 0; i < WORD_LEN; i++){
      if (char === WORD.charAt(i)){

        var x_ = 25;

        var cur = char + char + char;
        x_ = x_ + (50 * i);
        tmp = this.add.sprite(x_, 25, cur);
        tmp.setDisplaySize(40, 40);
        letterBoard.splice(index, 1);
        visitChecker[i] = "";
        console.log(letterBoard);
      }

    }

    }
  }

function hitDoor (player, door)
{
  var cond = true;
  for (var i = 0; i < WORD_LEN; i++){
    if (visitChecker[i] != "visited"){
      cond = false;
    }
  }
  if (cond === true){
    this.physics.pause();
    player.anims.play('turn');
    gameOver = true;
  }

}

function enemyCollision(player, enemy){
  // alert("eneterd");
//  enemy.disableBody(true, true);
  //throwLetter();
}

function hitWall(enemy, wall){
    console.log("hitWall");
    var speed = enemy.body.velocity.x
    speed = -1 *speed;
    enemy.body.setVelocityX(speed);
    //enemy is moving leftwards
    if ( speed >0){
        enemy.anims.play("enemyTurn",true)
    }
    else{
        enemy.anims.play("enemyMove",true)
    }

    //console.log(enemy.body.velocity.x)
}

</script>

</body>
</html>
